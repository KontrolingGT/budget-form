<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formularz Budżetu GT</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; padding: 20px; background-color: #F4F4F4; }
        .budget-container { background-color: #FFFFFF; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); border: 2px solid #000000; }
        h2, h3, h4, h5 { color: #F05A28; }
        input, select, textarea, button { margin: 10px 0; padding: 8px; width: 100%; box-sizing: border-box; border: 1px solid #000000; border-radius: 4px; }
        button { background-color: #F05A28; color: #FFFFFF; border: none; cursor: pointer; font-weight: bold; }
        button:hover { background-color: #D94A20; }
        #send-data, #download-excel, #download-json { background-color: #000000; color: #FFFFFF; }
        #send-data:hover, #download-excel:hover, #download-json:hover { background-color: #333333; }
        #clear-data { background-color: #F05A28; }
        #clear-data:hover { background-color: #D94A20; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; border: 1px solid #000000; }
        th, td { border: 1px solid #000000; padding: 8px; text-align: left; color: #000000; }
        th { background-color: #F05A28; color: #FFFFFF; }
        .section { margin-bottom: 20px; }
        .month-inputs { display: flex; flex-wrap: wrap; gap: 10px; }
        .month-inputs input { width: 120px; }
        label { color: #000000; display: block; margin-bottom: 5px; }
    </style>
</head>
<body>
    <div class="budget-container">
        <h2>Formularz Budżetu GT</h2>

        <!-- Sekcja: Dane kandydata -->
        <div class="section">
            <h3>Dane kandydata</h3>
            <input type="text" id="candidate-name" placeholder="Imię i nazwisko">
            <input type="email" id="candidate-email" placeholder="E-mail">
            <input type="text" id="candidate-city" placeholder="Miasto">
            <input type="text" id="candidate-phone" placeholder="Telefon">
            <label for="candidate-start-date">Data startu oddziału:</label>
            <input type="date" id="candidate-start-date">
            <select id="candidate-employment">
                <option value="">Wybierz formę zatrudnienia</option>
                <option value="B2B">B2B</option>
                <option value="Umowa o pracę">Umowa o pracę</option>
            </select>
        </div>

        <!-- Sekcja: Klienci -->
        <div class="section">
            <h3>Dane klientów</h3>
            <div id="clients-section">
                <div class="client">
                    <h4>Klient 1</h4>
                    <div class="month-inputs" id="client-1-incomes"></div>
                    <div class="month-inputs" id="client-1-costs"></div>
                    <div class="month-inputs" id="client-1-orders"></div>
                </div>
            </div>
            <button onclick="addClient()">Dodaj kolejnego klienta</button>
        </div>

        <!-- Sekcja: Zatrudnienie -->
        <div class="section">
            <h3>Zatrudnienie</h3>
            <div id="employees-section">
                <div class="employee">
                    <h4>Pracownik 1</h4>
                    <input type="text" data-employee="1" data-type="name" placeholder="Imię i nazwisko">
                    <input type="date" data-employee="1" data-type="hire-date" placeholder="Data zatrudnienia">
                    <input type="text" data-employee="1" data-type="role" placeholder="Rola">
                    <input type="number" data-employee="1" data-type="salary" placeholder="Kwota [PLN]">
                    <select data-employee="1" data-type="employment">
                        <option value="">Wybierz formę zatrudnienia</option>
                        <option value="B2B">B2B</option>
                        <option value="Umowa o pracę">Umowa o pracę</option>
                    </select>
                </div>
            </div>
            <button onclick="addEmployee()">Dodaj kolejnego pracownika</button>
        </div>

        <!-- Sekcja: Pojazdy służbowe -->
        <div class="section">
            <h3>Pojazdy służbowe</h3>
            <div id="vehicles-section">
                <div class="vehicle">
                    <h4>Pojazd 1</h4>
                    <input type="text" data-vehicle="1" data-type="description" placeholder="Opis pojazdu">
                    <input type="date" data-vehicle="1" data-type="start-date" placeholder="Od kiedy">
                    <input type="number" data-vehicle="1" data-type="quantity" placeholder="Ilość">
                </div>
            </div>
            <button onclick="addVehicle()">Dodaj kolejny pojazd</button>
        </div>

        <!-- Sekcja: Uzupełniające informacje -->
        <div class="section">
            <h3>Uzupełniające informacje</h3>
            <input type="text" id="branch-work-type" placeholder="Forma pracy oddziału">
            <input type="number" id="office-rent-cost" placeholder="Szacowane miesięczne koszty najmu biura (PLN)">
            <label><input type="checkbox" id="exchange-timo"> Dostęp do giełdy Timo</label>
            <label><input type="checkbox" id="exchange-trans"> Dostęp do giełdy Trans</label>
            <input type="text" id="exchange-other" placeholder="Inne giełdy">
            <label><input type="checkbox" id="has-carriers" onchange="toggleCarriersComment()"> Posiada bazę przewoźników</label>
            <textarea id="carriers-comment" placeholder="Komentarz do bazy przewoźników" style="display: none;"></textarea>
            <div id="clients-info-section">
                <h4>Informacje o klientach</h4>
                <div class="client-info">
                    <h5>Klient 1</h5>
                    <select data-client="1" data-type="client-type">
                        <option value="">Typ klienta</option>
                        <option value="Bezpośredni">Bezpośredni</option>
                        <option value="Operator logistyczny">Operator logistyczny</option>
                        <option value="Spedycyjny">Spedycyjny</option>
                    </select>
                    <select data-client="1" data-type="transport-type">
                        <option value="">Rodzaj transportu</option>
                        <option value="Krajowy">Krajowy</option>
                        <option value="Zagraniczny">Zagraniczny</option>
                    </select>
                    <select data-client="1" data-type="tender-type">
                        <option value="">Typ klienta</option>
                        <option value="Przetargowy">Przetargowy</option>
                        <option value="Giełdowy">Giełdowy</option>
                    </select>
                    <input type="date" data-client="1" data-type="tender-date" placeholder="Data wdrożenia (jeśli przetargowy)">
                    <input type="text" data-client="1" data-type="directions" placeholder="Główne kierunki">
                    <select data-client="1" data-type="load-type">
                        <option value="">Rodzaj ładunków</option>
                        <option value="FTL">FTL</option>
                        <option value="LTL">LTL</option>
                    </select>
                    <label><input type="checkbox" data-client="1" data-type="has-contracts"> Związany umowami z poprzednią firmą</label>
                </div>
            </div>
            <button onclick="addClientInfo()">Dodaj informacje o kolejnym kliencie</button>
            <textarea id="candidate-comments" placeholder="Opis / Komentarz / Uwagi kandydata"></textarea>
        </div>

        <!-- Podgląd danych -->
        <div class="section">
            <h3>Podgląd danych</h3>
            <table>
                <thead>
                    <tr>
                        <th>Sekcja</th>
                        <th>Dane</th>
                    </tr>
                </thead>
                <tbody id="data-table-body"></tbody>
            </table>
        </div>

        <!-- Przyciski akcji -->
        <button id="send-data" onclick="sendData()">Wyślij dane e-mailem</button>
        <button id="download-excel" onclick="downloadExcel()">Pobierz dane jako Excel</button>
        <button id="download-json" onclick="downloadJson()">Pobierz dane jako JSON</button>
        <button id="clear-data" onclick="clearData()">Wyczyść wszystkie dane</button>
    </div>

    <!-- Biblioteki zewnętrzne -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        (function() {
            emailjs.init("5Vf4_3IwKm09MW_ZZ"); // EmailJS Public Key
        })();

        let clients = [{ incomes: {}, costs: {}, orders: {} }];
        let employees = [{}];
        let vehicles = [{}];
        let candidate = {};
        let additionalInfo = { clientsInfo: [{}] };

        // Mapowanie miesięcy na kolumny Excela
        const MONTH_COLUMNS = ['D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O'];

        // Generowanie etykiet miesięcy na podstawie daty startu
        function getMonthLabels(startDate) {
            if (!startDate) return MONTH_COLUMNS.map((_, i) => `Miesiąc ${i + 1}`);
            const date = new Date(startDate);
            const months = [];
            for (let i = 0; i < 12; i++) {
                const month = new Date(date.getFullYear(), date.getMonth() + i, 1);
                months.push(month.toLocaleString('pl-PL', { month: 'long', year: 'numeric' }).replace(' ', ' '));
            }
            return months;
        }

        // Aktualizacja pól klientów
        function updateClientsSection() {
            const startDate = document.getElementById('candidate-start-date').value;
            const monthLabels = getMonthLabels(startDate);
            const section = document.getElementById('clients-section');
            section.innerHTML = '';
            clients.forEach((client, index) => {
                const div = document.createElement('div');
                div.className = 'client';
                div.innerHTML = `
                    <h4>Klient ${index + 1}</h4>
                    <div class="month-inputs" id="client-${index + 1}-incomes">
                        ${monthLabels.map((label, i) => `
                            <input type="number" data-client="${index + 1}" data-type="income" data-month="${label}" placeholder="Przychody ${label}" value="${client.incomes[label] || ''}">
                        `).join('')}
                    </div>
                    <div class="month-inputs" id="client-${index + 1}-costs">
                        ${monthLabels.map((label, i) => `
                            <input type="number" data-client="${index + 1}" data-type="cost" data-month="${label}" placeholder="Koszty ${label}" value="${client.costs[label] || ''}">
                        `).join('')}
                    </div>
                    <div class="month-inputs" id="client-${index + 1}-orders">
                        ${monthLabels.map((label, i) => `
                            <input type="number" data-client="${index + 1}" data-type="order" data-month="${label}" placeholder="Zlecenia ${label}" value="${client.orders[label] || ''}">
                        `).join('')}
                    </div>
                `;
                section.appendChild(div);
            });
        }

        // Wczytywanie danych z localStorage
        window.onload = function() {
            const savedData = localStorage.getItem('budgetData');
            if (savedData) {
                const data = JSON.parse(savedData);
                clients = data.clients || [{ incomes: {}, costs: {}, orders: {} }];
                employees = data.employees || [{}];
                vehicles = data.vehicles || [{}];
                candidate = data.candidate || {};
                additionalInfo = data.additionalInfo || { clientsInfo: [{}] };
                document.getElementById('candidate-name').value = candidate.name || '';
                document.getElementById('candidate-email').value = candidate.email || '';
                document.getElementById('candidate-city').value = candidate.city || '';
                document.getElementById('candidate-phone').value = candidate.phone || '';
                document.getElementById('candidate-start-date').value = candidate.startDate || '';
                document.getElementById('candidate-employment').value = candidate.employment || '';
                updateClientsSection();
                updateEmployeesSection();
                updateVehiclesSection();
                updateClientInfoSection();
                updateTable();
            }
            updateClientsSection();
        };

        // Funkcje dodawania elementów
        function addClient() {
            if (clients.length < 10) {
                clients.push({ incomes: {}, costs: {}, orders: {} });
                updateClientsSection();
            } else {
                alert('Maksymalna liczba klientów wynosi 10.');
            }
        }

        function addEmployee() {
            if (employees.length < 15) {
                employees.push({});
                updateEmployeesSection();
            } else {
                alert('Maksymalna liczba pracowników to 15.');
            }
        }

        function addVehicle() {
            if (vehicles.length < 5) {
                vehicles.push({});
                updateVehiclesSection();
            } else {
                alert('Maksymalna liczba pojazdów to 5.');
            }
        }

        function addClientInfo() {
            if (additionalInfo.clientsInfo.length < 10) {
                additionalInfo.clientsInfo.push({});
                updateClientInfoSection();
            } else {
                alert('Maksymalna liczba klientów w informacjach dodatkowych wynosi 10.');
            }
        }

        function updateEmployeesSection() {
            const section = document.getElementById('employees-section');
            section.innerHTML = '';
            employees.forEach((employee, index) => {
                const div = document.createElement('div');
                div.className = 'employee';
                div.innerHTML = `
                    <h4>Pracownik ${index + 1}</h4>
                    <input type="text" data-employee="${index + 1}" data-type="name" placeholder="Imię i nazwisko" value="${employee.name || ''}">
                    <input type="date" data-employee="${index + 1}" data-type="hire-date" placeholder="Data zatrudnienia" value="${employee.hireDate || ''}">
                    <input type="text" data-employee="${index + 1}" data-type="role" placeholder="Rola" value="${employee.role || ''}">
                    <input type="number" data-employee="${index + 1}" data-type="salary" placeholder="Kwota [PLN]" value="${employee.salary || ''}">
                    <select data-employee="${index + 1}" data-type="employment">
                        <option value="">Wybierz formę zatrudnienia</option>
                        <option value="B2B" ${employee.employment === 'B2B' ? 'selected' : ''}>B2B</option>
                        <option value="Umowa o pracę" ${employee.employment === 'Umowa o pracę' ? 'selected' : ''}>Umowa o pracę</option>
                    </select>
                `;
                section.appendChild(div);
            });
        }

        function updateVehiclesSection() {
            const section = document.getElementById('vehicles-section');
            section.innerHTML = '';
            vehicles.forEach((vehicle, index) => {
                const div = document.createElement('div');
                div.className = 'vehicle';
                div.innerHTML = `
                    <h4>Pojazd ${index + 1}</h4>
                    <input type="text" data-vehicle="${index + 1}" data-type="description" placeholder="Opis pojazdu" value="${vehicle.description || ''}">
                    <input type="date" data-vehicle="${index + 1}" data-type="start-date" placeholder="Od kiedy" value="${vehicle.startDate || ''}">
                    <input type="number" data-vehicle="${index + 1}" data-type="quantity" placeholder="Ilość" value="${vehicle.quantity || ''}">
                `;
                section.appendChild(div);
            });
        }

        function updateClientInfoSection() {
            const section = document.getElementById('clients-info-section');
            section.innerHTML = '<h4>Informacje o klientach</h4>';
            additionalInfo.clientsInfo.forEach((info, index) => {
                const div = document.createElement('div');
                div.className = 'client-info';
                div.innerHTML = `
                    <h5>Klient ${index + 1}</h5>
                    <select data-client="${index + 1}" data-type="client-type">
                        <option value="">Typ klienta</option>
                        <option value="Bezpośredni" ${info.clientType === 'Bezpośredni' ? 'selected' : ''}>Bezpośredni</option>
                        <option value="Operator logistyczny" ${info.clientType === 'Operator logistyczny' ? 'selected' : ''}>Operator logistyczny</option>
                        <option value="Spedycyjny" ${info.clientType === 'Spedycyjny' ? 'selected' : ''}>Spedycyjny</option>
                    </select>
                    <select data-client="${index + 1}" data-type="transport-type">
                        <option value="">Rodzaj transportu</option>
                        <option value="Krajowy" ${info.transportType === 'Krajowy' ? 'selected' : ''}>Krajowy</option>
                        <option value="Zagraniczny" ${info.transportType === 'Zagraniczny' ? 'selected' : ''}>Zagraniczny</option>
                    </select>
                    <select data-client="${index + 1}" data-type="tender-type">
                        <option value="">Typ klienta</option>
                        <option value="Przetargowy" ${info.tenderType === 'Przetargowy' ? 'selected' : ''}>Przetargowy</option>
                        <option value="Giełdowy" ${info.tenderType === 'Giełdowy' ? 'selected' : ''}>Giełdowy</option>
                    </select>
                    <input type="date" data-client="${index + 1}" data-type="tender-date" placeholder="Data wdrożenia (jeśli przetargowy)" value="${info.tenderDate || ''}">
                    <input type="text" data-client="${index + 1}" data-type="directions" placeholder="Główne kierunki" value="${info.directions || ''}">
                    <select data-client="${index + 1}" data-type="load-type">
                        <option value="">Rodzaj ładunków</option>
                        <option value="FTL" ${info.loadType === 'FTL' ? 'selected' : ''}>FTL</option>
                        <option value="LTL" ${info.loadType === 'LTL' ? 'selected' : ''}>LTL</option>
                    </select>
                    <label><input type="checkbox" data-client="${index + 1}" data-type="has-contracts" ${info.hasContracts ? 'checked' : ''}> Związany umowami z poprzednią firmą</label>
                `;
                section.appendChild(div);
            });
        }

        function toggleCarriersComment() {
            const checkbox = document.getElementById('has-carriers');
            const comment = document.getElementById('carriers-comment');
            comment.style.display = checkbox.checked ? 'block' : 'none';
        }

        function saveData() {
            candidate = {
                name: document.getElementById('candidate-name').value,
                email: document.getElementById('candidate-email').value,
                city: document.getElementById('candidate-city').value,
                phone: document.getElementById('candidate-phone').value,
                startDate: document.getElementById('candidate-start-date').value,
                employment: document.getElementById('candidate-employment').value
            };

            clients = Array.from(document.querySelectorAll('.client')).map((div, index) => {
                const incomes = {};
                const costs = {};
                const orders = {};
                document.querySelectorAll(`.client input[data-client="${index + 1}"][data-type="income"]`).forEach(input => {
                    if (input.value) incomes[input.dataset.month] = parseFloat(input.value) || 0;
                });
                document.querySelectorAll(`.client input[data-client="${index + 1}"][data-type="cost"]`).forEach(input => {
                    if (input.value) costs[input.dataset.month] = parseFloat(input.value) || 0;
                });
                document.querySelectorAll(`.client input[data-client="${index + 1}"][data-type="order"]`).forEach(input => {
                    if (input.value) orders[input.dataset.month] = parseInt(input.value) || 0;
                });
                return { incomes, costs, orders };
            });

            employees = Array.from(document.querySelectorAll('.employee')).map((div, index) => {
                return {
                    name: document.querySelector(`.employee input[data-employee="${index + 1}"][data-type="name"]`).value,
                    hireDate: document.querySelector(`.employee input[data-employee="${index + 1}"][data-type="hire-date"]`).value,
                    role: document.querySelector(`.employee input[data-employee="${index + 1}"][data-type="role"]`).value,
                    salary: parseFloat(document.querySelector(`.employee input[data-employee="${index + 1}"][data-type="salary"]`).value) || 0,
                    employment: document.querySelector(`.employee select[data-employee="${index + 1}"][data-type="employment"]`).value
                };
            });

            vehicles = Array.from(document.querySelectorAll('.vehicle')).map((div, index) => {
                return {
                    description: document.querySelector(`.vehicle input[data-vehicle="${index + 1}"][data-type="description"]`).value,
                    startDate: document.querySelector(`.vehicle input[data-vehicle="${index + 1}"][data-type="start-date"]`).value,
                    quantity: parseInt(document.querySelector(`.vehicle input[data-vehicle="${index + 1}"][data-type="quantity"]`).value) || 0
                };
            });

            additionalInfo = {
                branchWorkType: document.getElementById('branch-work-type').value,
                officeRentCost: parseFloat(document.getElementById('office-rent-cost').value) || 0,
                exchangeTimo: document.getElementById('exchange-timo').checked,
                exchangeTrans: document.getElementById('exchange-trans').checked,
                exchangeOther: document.getElementById('exchange-other').value,
                hasCarriers: document.getElementById('has-carriers').checked,
                carriersComment: document.getElementById('carriers-comment').value,
                clientsInfo: Array.from(document.querySelectorAll('.client-info')).map((div, index) => {
                    return {
                        clientType: document.querySelector(`.client-info select[data-client="${index + 1}"][data-type="client-type"]`).value,
                        transportType: document.querySelector(`.client-info select[data-client="${index + 1}"][data-type="transport-type"]`).value,
                        tenderType: document.querySelector(`.client-info select[data-client="${index + 1}"][data-type="tender-type"]`).value,
                        tenderDate: document.querySelector(`.client-info input[data-client="${index + 1}"][data-type="tender-date"]`).value,
                        directions: document.querySelector(`.client-info input[data-client="${index + 1}"][data-type="directions"]`).value,
                        loadType: document.querySelector(`.client-info select[data-client="${index + 1}"][data-type="load-type"]`).value,
                        hasContracts: document.querySelector(`.client-info input[data-client="${index + 1}"][data-type="has-contracts"]`).checked
                    };
                }),
                candidateComments: document.getElementById('candidate-comments').value
            };

            localStorage.setItem('budgetData', JSON.stringify({ candidate, clients, employees, vehicles, additionalInfo }));
            updateTable();
        }

        function updateTable() {
            const tableBody = document.getElementById('data-table-body');
            tableBody.innerHTML = '';

            if (candidate.name || candidate.email || candidate.city || candidate.phone || candidate.startDate || candidate.employment) {
                const row = document.createElement('tr');
                row.innerHTML = `<td>Dane kandydata</td><td>Imię: ${candidate.name || ''}, E-mail: ${candidate.email || ''}, Miasto: ${candidate.city || ''}, Telefon: ${candidate.phone || ''}, Data startu: ${candidate.startDate || ''}, Forma: ${candidate.employment || ''}</td>`;
                tableBody.appendChild(row);
            }

            clients.forEach((client, index) => {
                const incomes = Object.entries(client.incomes).map(([month, value]) => `${month}: ${value.toFixed(2)} PLN`).join(', ');
                const costs = Object.entries(client.costs).map(([month, value]) => `${month}: ${value.toFixed(2)} PLN`).join(', ');
                const orders = Object.entries(client.orders).map(([month, value]) => `${month}: ${value}`).join(', ');
                if (incomes || costs || orders) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>Klient ${index + 1}</td><td>Przychody: ${incomes || 'Brak'}, Koszty: ${costs || 'Brak'}, Zlecenia: ${orders || 'Brak'}</td>`;
                    tableBody.appendChild(row);
                }
            });

            employees.forEach((employee, index) => {
                if (employee.name || employee.hireDate || employee.role || employee.salary || employee.employment) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>Pracownik ${index + 1}</td><td>Imię: ${employee.name || ''}, Data zatrudnienia: ${employee.hireDate || ''}, Rola: ${employee.role || ''}, Kwota: ${employee.salary ? employee.salary.toFixed(2) : '0'} PLN, Forma: ${employee.employment || ''}</td>`;
                    tableBody.appendChild(row);
                }
            });

            vehicles.forEach((vehicle, index) => {
                if (vehicle.description || vehicle.startDate || vehicle.quantity) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>Pojazd ${index + 1}</td><td>Opis: ${vehicle.description || ''}, Od kiedy: ${vehicle.startDate || ''}, Ilość: ${vehicle.quantity || 0}</td>`;
                    tableBody.appendChild(row);
                }
            });

            if (additionalInfo.branchWorkType || additionalInfo.officeRentCost || additionalInfo.exchangeTimo || additionalInfo.exchangeTrans || additionalInfo.exchangeOther || additionalInfo.hasCarriers || additionalInfo.carriersComment || additionalInfo.candidateComments) {
                const row = document.createElement('tr');
                row.innerHTML = `<td>Uzupełniające informacje</td><td>Forma pracy: ${additionalInfo.branchWorkType || ''}, Koszty najmu: ${additionalInfo.officeRentCost ? additionalInfo.officeRentCost.toFixed(2) : '0'} PLN, Giełdy: Timo: ${additionalInfo.exchangeTimo ? 'Tak' : 'Nie'}, Trans: ${additionalInfo.exchangeTrans ? 'Tak' : 'Nie'}, Inne: ${additionalInfo.exchangeOther || ''}, Baza przewoźników: ${additionalInfo.hasCarriers ? 'Tak' : 'Nie'}, Komentarz: ${additionalInfo.carriersComment || ''}, Uwagi: ${additionalInfo.candidateComments || ''}</td>`;
                tableBody.appendChild(row);
            }

            additionalInfo.clientsInfo.forEach((info, index) => {
                if (info.clientType || info.transportType || info.tenderType || info.tenderDate || info.directions || info.loadType || info.hasContracts) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>Info o kliencie ${index + 1}</td><td>Typ: ${info.clientType || ''}, Transport: ${info.transportType || ''}, Przetarg/Giełda: ${info.tenderType || ''}, Data wdrożenia: ${info.tenderDate || ''}, Kierunki: ${info.directions || ''}, Ładunki: ${info.loadType || ''}, Umowy: ${info.hasContracts ? 'Tak' : 'Nie'}</td>`;
                    tableBody.appendChild(row);
                }
            });
        }

        function generateExcel() {
            try {
                console.log('Generating Excel...');
                const wb = XLSX.utils.book_new();
                const startDate = candidate.startDate || new Date().toISOString().split('T')[0];
                const monthLabels = getMonthLabels(startDate);

                // Arkusz "Informacje ogólne"
                const ws_info_data = [{
                    "Imię": candidate.name || "",
                    "E-mail": candidate.email || "",
                    "Miasto": candidate.city || "",
                    "Telefon": candidate.phone || "",
                    "Data startu oddziału": candidate.startDate || "",
                    "Forma zatrudnienia": candidate.employment || ""
                }];
                const ws_info = XLSX.utils.json_to_sheet(ws_info_data, { origin: "B2" });
                XLSX.utils.book_append_sheet(wb, ws_info, "Informacje ogólne");

                // Arkusz "Klienci"
                const ws_clients_data = [];
                clients.forEach((client, idx) => {
                    const incomes = client.incomes || {};
                    const costs = client.costs || {};
                    const orders = client.orders || {};
                    const baseRow = 6 + 5 * idx;
                    const row_przychody = { "Opis": `Przychody Klient ${idx + 1}` };
                    const row_koszty = { "Opis": `Koszty Klient ${idx + 1}` };
                    const row_zlecenia = { "Opis": `Zlecenia Klient ${idx + 1}` };
                    monthLabels.forEach((month, i) => {
                        row_przychody[MONTH_COLUMNS[i]] = incomes[month] || 0;
                        row_koszty[MONTH_COLUMNS[i]] = costs[month] || 0;
                        row_zlecenia[MONTH_COLUMNS[i]] = orders[month] || 0;
                    });
                    ws_clients_data.push(
                        { row: baseRow, data: row_przychody },
                        { row: baseRow + 1, data: row_koszty },
                        { row: baseRow + 4, data: row_zlecenia }
                    );
                });
                const ws_clients = XLSX.utils.json_to_sheet([]);
                ws_clients_data.forEach(({ row, data }) => {
                    XLSX.utils.sheet_add_json(ws_clients, [data], { origin: `B${row}`, skipHeader: true });
                });
                XLSX.utils.book_append_sheet(wb, ws_clients, "Klienci");

                // Arkusz "Zatrudnienie"
                const ws_employees_data = employees.map((emp, idx) => ({
                    "Imię": emp.name || "",
                    "Data zatrudnienia": emp.hireDate || "",
                    "Rola": emp.role || "",
                    "Kwota": emp.salary || 0,
                    "Forma zatrudnienia": emp.employment || ""
                }));
                const ws_employees = XLSX.utils.json_to_sheet(ws_employees_data, { origin: "B20" });
                XLSX.utils.book_append_sheet(wb, ws_employees, "Zatrudnienie");

                // Arkusz "Pojazdy"
                const ws_vehicles_data = vehicles.map((veh, idx) => ({
                    "Opis": veh.description || "",
                    "Od kiedy": veh.startDate || "",
                    "Ilość": veh.quantity || 0
                }));
                const ws_vehicles = XLSX.utils.json_to_sheet(ws_vehicles_data, { origin: "B30" });
                XLSX.utils.book_append_sheet(wb, ws_vehicles, "Pojazdy");

                // Arkusz "Dodatkowe"
                const ws_additional_data = [{
                    "Forma pracy oddziału": additionalInfo.branchWorkType || "",
                    "Koszty najmu": additionalInfo.officeRentCost || 0,
                    "Giełda Timo": additionalInfo.exchangeTimo ? "Tak" : "Nie",
                    "Giełda Trans": additionalInfo.exchangeTrans ? "Tak" : "Nie",
                    "Inne giełdy": additionalInfo.exchangeOther || "",
                    "Baza przewoźników": additionalInfo.hasCarriers ? "Tak" : "Nie",
                    "Komentarz przewoźników": additionalInfo.carriersComment || "",
                    "Uwagi kandydata": additionalInfo.candidateComments || ""
                }];
                const ws_additional = XLSX.utils.json_to_sheet(ws_additional_data, { origin: "B40" });
                const ws_clients_info_data = additionalInfo.clientsInfo.map((info, idx) => ({
                    "Typ klienta": info.clientType || "",
                    "Rodzaj transportu": info.transportType || "",
                    "Przetarg/Giełda": info.tenderType || "",
                    "Data wdrożenia": info.tenderDate || "",
                    "Kierunki": info.directions || "",
                    "Rodzaj ładunków": info.loadType || "",
                    "Umowy": info.hasContracts ? "Tak" : "Nie"
                }));
                XLSX.utils.sheet_add_json(ws_additional, ws_clients_info_data, { origin: "B50", skipHeader: true });
                XLSX.utils.book_append_sheet(wb, ws_additional, "Dodatkowe");

                console.log('Excel generated successfully');
                return wb;
            } catch (error) {
                console.error('Error in generateExcel:', error);
                throw error;
            }
        }

        function downloadExcel() {
            try {
                saveData();
                const wb = generateExcel();
                XLSX.writeFile(wb, `GT_Budzet_${candidate.name || 'Anonim'}_${new Date().toISOString().split('T')[0]}.xlsx`);
                alert('Plik Excel został wygenerowany i pobrany!');
            } catch (error) {
                console.error('Error in downloadExcel:', error);
                alert('Błąd podczas generowania pliku Excel: ' + error.message);
            }
        }

        function sendData() {
            saveData();
            if (!candidate.name || !candidate.email) {
                alert('Proszę wypełnić imię i e-mail kandydata przed wysłaniem.');
                return;
            }

            const monthLabels = getMonthLabels(candidate.startDate);
            const emailContent = `
                Dane kandydata:
                Imię: ${candidate.name || ''}
                E-mail: ${candidate.email || ''}
                Miasto: ${candidate.city || ''}
                Telefon: ${candidate.phone || ''}
                Data startu oddziału: ${candidate.startDate || ''}
                Forma zatrudnienia: ${candidate.employment || ''}

                Klienci:
                ${clients.map((client, idx) => `
                    Klient ${idx + 1}:
                    Przychody: ${Object.entries(client.incomes).map(([month, value]) => `${month}: ${value.toFixed(2)} PLN`).join(', ') || 'Brak'}
                    Koszty: ${Object.entries(client.costs).map(([month, value]) => `${month}: ${value.toFixed(2)} PLN`).join(', ') || 'Brak'}
                    Zlecenia: ${Object.entries(client.orders).map(([month, value]) => `${month}: ${value}`).join(', ') || 'Brak'}
                `).join('\n')}

                Zatrudnienie:
                ${employees.map((emp, idx) => `
                    Pracownik ${idx + 1}:
                    Imię: ${emp.name || ''}
                    Data zatrudnienia: ${emp.hireDate || ''}
                    Rola: ${emp.role || ''}
                    Kwota: ${emp.salary ? emp.salary.toFixed(2) : '0'} PLN
                    Forma: ${emp.employment || ''}
                `).join('\n')}

                Pojazdy służbowe:
                ${vehicles.map((veh, idx) => `
                    Pojazd ${idx + 1}:
                    Opis: ${veh.description || ''}
                    Od kiedy: ${veh.startDate || ''}
                    Ilość: ${veh.quantity || 0}
                `).join('\n')}

                Uzupełniające informacje:
                Forma pracy oddziału: ${additionalInfo.branchWorkType || ''}
                Koszty najmu: ${additionalInfo.officeRentCost ? additionalInfo.officeRentCost.toFixed(2) : '0'} PLN
                Giełdy:
                - Timo: ${additionalInfo.exchangeTimo ? 'Tak' : 'Nie'}
                - Trans: ${additionalInfo.exchangeTrans ? 'Tak' : 'Nie'}
                - Inne: ${additionalInfo.exchangeOther || ''}
                Baza przewoźników: ${additionalInfo.hasCarriers ? 'Tak' : 'Nie'}
                Komentarz przewoźników: ${additionalInfo.carriersComment || ''}
                Informacje o klientach:
                ${additionalInfo.clientsInfo.map((info, idx) => `
                    Klient ${idx + 1}:
                    Typ: ${info.clientType || ''}
                    Transport: ${info.transportType || ''}
                    Przetarg/Giełda: ${info.tenderType || ''}
                    Data wdrożenia: ${info.tenderDate || ''}
                    Kierunki: ${info.directions || ''}
                    Ładunki: ${info.loadType || ''}
                    Umowy: ${info.hasContracts ? 'Tak' : 'Nie'}
                `).join('\n')}
                Uwagi kandydata: ${additionalInfo.candidateComments || ''}
            `;

            emailjs.send('service_a1360jq', 'template_ujx0hdd', {
                from_name: candidate.name || 'Użytkownik formularza',
                email: candidate.email,
                message: emailContent.trim(),
                timestamp: new Date().toISOString()
            }).then(
                () => alert('Dane zostały wysłane na e-mail!'),
                (error) => {
                    console.error('Error in sendData:', error);
                    alert('Błąd podczas wysyłania: ' + error.text);
                }
            );
        }

        function downloadJson() {
            try {
                saveData();
                const budgetData = {
                    candidate,
                    clients,
                    employees,
                    vehicles,
                    additionalInfo,
                    timestamp: new Date().toISOString()
                };
                const dataStr = JSON.stringify(budgetData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'budget_data.json';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Error in downloadJson:', error);
                alert('Błąd podczas pobierania JSON: ' + error.message);
            }
        }

        function clearData() {
            if (confirm('Czy na pewno chcesz wyczyścić wszystkie dane?')) {
                candidate = {};
                clients = [{ incomes: {}, costs: {}, orders: {} }];
                employees = [{}];
                vehicles = [{}];
                additionalInfo = { clientsInfo: [{}] };
                localStorage.removeItem('budgetData');
                document.querySelectorAll('input, select, textarea').forEach(input => {
                    if (input.type === 'checkbox') input.checked = false;
                    else input.value = '';
                });
                updateClientsSection();
                updateEmployeesSection();
                updateVehiclesSection();
                updateClientInfoSection();
                updateTable();
            }
        }

        // Automatyczne zapisywanie i aktualizacja pól klientów po zmianie danych
        document.querySelectorAll('input, select, textarea').forEach(element => {
            element.addEventListener('change', () => {
                saveData();
                updateClientsSection();
            });
        });
    </script>
</body>
</html>